import tkinter as tk
from tkinter import colorchooser, filedialog
from PIL import Image, ImageDraw, ImageTk

class DrawingApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Рисовалка с инструментами")
        self.root.geometry("800x600")
        
        # Переменные для рисования
        self.current_tool = "brush"
        self.brush_size = 3
        self.current_color = "black"
        self.start_x = None
        self.start_y = None
        self.drawing = False
        
        self.create_widgets()
        self.setup_canvas()
    
    def create_widgets(self):
        """Создание интерфейса"""
        # Верхняя панель инструментов
        toolbar = tk.Frame(self.root, bg="lightgray")
        toolbar.pack(side=tk.TOP, fill=tk.X)
        
        # Кнопки инструментов
        tools_frame = tk.Frame(toolbar)
        tools_frame.pack(side=tk.LEFT, padx=5)
        
        tk.Button(tools_frame, text="Кисть", command=lambda: self.select_tool("brush")).pack(side=tk.LEFT, padx=2)
        tk.Button(tools_frame, text="Ластик", command=lambda: self.select_tool("eraser")).pack(side=tk.LEFT, padx=2)
        tk.Button(tools_frame, text="Линия", command=lambda: self.select_tool("line")).pack(side=tk.LEFT, padx=2)
        tk.Button(tools_frame, text="Прямоугольник", command=lambda: self.select_tool("rectangle")).pack(side=tk.LEFT, padx=2)
        tk.Button(tools_frame, text="Овал", command=lambda: self.select_tool("oval")).pack(side=tk.LEFT, padx=2)
        
        # Выбор цвета
        color_frame = tk.Frame(toolbar)
        color_frame.pack(side=tk.LEFT, padx=10)
        
        tk.Label(color_frame, text="Цвет:").pack(side=tk.LEFT)
        self.color_btn = tk.Button(color_frame, bg=self.current_color, width=2, 
                                  command=self.choose_color)
        self.color_btn.pack(side=tk.LEFT, padx=5)
        
        # Выбор размера кисти
        size_frame = tk.Frame(toolbar)
        size_frame.pack(side=tk.LEFT, padx=10)
        
        tk.Label(size_frame, text="Размер:").pack(side=tk.LEFT)
        self.size_var = tk.IntVar(value=self.brush_size)
        size_spin = tk.Spinbox(size_frame, from_=1, to=20, textvariable=self.size_var,
                              width=3, command=self.update_brush_size)
        size_spin.pack(side=tk.LEFT, padx=5)
        
        # Кнопки управления
        control_frame = tk.Frame(toolbar)
        control_frame.pack(side=tk.RIGHT, padx=10)
        
        tk.Button(control_frame, text="Очистить", command=self.clear_canvas).pack(side=tk.LEFT, padx=2)
        tk.Button(control_frame, text="Сохранить", command=self.save_canvas).pack(side=tk.LEFT, padx=2)
        
        # Холст для рисования
        self.canvas = tk.Canvas(self.root, bg="white", width=800, height=500)
        self.canvas.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
    
    def setup_canvas(self):
        """Настройка событий холста"""
        self.canvas.bind("<Button-1>", self.start_draw)
        self.canvas.bind("<B1-Motion>", self.draw)
        self.canvas.bind("<ButtonRelease-1>", self.stop_draw)
    
    def select_tool(self, tool):
        """Выбор инструмента"""
        self.current_tool = tool
        if tool == "eraser":
            self.current_color = "white"
            self.color_btn.config(bg="white")
    
    def choose_color(self):
        """Выбор цвета"""
        color = colorchooser.askcolor(initialcolor=self.current_color)[1]
        if color:
            self.current_color = color
            self.color_btn.config(bg=color)
            self.current_tool = "brush"  # Возвращаем к кисти после выбора цвета
    
    def update_brush_size(self):
        """Обновление размера кисти"""
        self.brush_size = self.size_var.get()
    
    def start_draw(self, event):
        """Начало рисования"""
        self.drawing = True
        self.start_x = event.x
        self.start_y = event.y
        
        if self.current_tool == "brush":
            self.canvas.create_oval(event.x, event.y, event.x, event.y, 
                                   fill=self.current_color, 
                                   outline=self.current_color,
                                   width=self.brush_size)
    
    def draw(self, event):
        """Процесс рисования"""
        if not self.drawing:
            return
            
        if self.current_tool == "brush":
            self.canvas.create_line(self.start_x, self.start_y, event.x, event.y,
                                   fill=self.current_color, 
                                   width=self.brush_size,
                                   capstyle=tk.ROUND, smooth=tk.TRUE)
            self.start_x = event.x
            self.start_y = event.y
        elif self.current_tool == "eraser":
            self.canvas.create_line(self.start_x, self.start_y, event.x, event.y,
                                   fill="white", 
                                   width=self.brush_size * 2,
                                   capstyle=tk.ROUND)
            self.start_x = event.x
            self.start_y = event.y
    
    def stop_draw(self, event):
        """Окончание рисования"""
        if self.drawing and self.start_x and self.start_y:
            if self.current_tool == "line":
                self.canvas.create_line(self.start_x, self.start_y, event.x, event.y,
                                       fill=self.current_color, width=self.brush_size)
            elif self.current_tool == "rectangle":
                self.canvas.create_rectangle(self.start_x, self.start_y, event.x, event.y,
                                           outline=self.current_color, width=self.brush_size)
            elif self.current_tool == "oval":
                self.canvas.create_oval(self.start_x, self.start_y, event.x, event.y,
                                       outline=self.current_color, width=self.brush_size)
        
        self.drawing = False
        self.start_x = None
        self.start_y = None
    
    def clear_canvas(self):
        """Очистка холста"""
        self.canvas.delete("all")
    
    def save_canvas(self):
        """Сохранение рисунка"""
        filename = filedialog.asksaveasfilename(
            defaultextension=".png",
            filetypes=[("PNG files", "*.png"), ("All files", "*.*")]
        )
        if filename:
            # Сохраняем содержимое Canvas как PostScript и конвертируем в PNG
            self.canvas.postscript(file="temp.ps", colormode="color")
            img = Image.open("temp.ps")
            img.save(filename, "PNG")

root = tk.Tk()
app = DrawingApp(root)
root.mainloop()