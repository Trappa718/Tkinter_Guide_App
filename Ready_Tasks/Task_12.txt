import tkinter as tk
from tkinter import ttk, messagebox
import base64
import json
import os

class PasswordManager:
    def __init__(self, root):
        self.root = root
        self.root.title("Менеджер паролей")
        self.root.geometry("800x500")
        
        self.data_file = "passwords.json"
        self.passwords = self.load_data()
        
        self.create_widgets()
        self.refresh_treeview()
    
    def create_widgets(self):
        """Создание интерфейса"""
        # Верхняя панель с кнопками
        toolbar = tk.Frame(self.root)
        toolbar.pack(fill=tk.X, padx=10, pady=10)
        
        tk.Button(toolbar, text="Добавить", command=self.add_password).pack(side=tk.LEFT, padx=5)
        tk.Button(toolbar, text="Редактировать", command=self.edit_password).pack(side=tk.LEFT, padx=5)
        tk.Button(toolbar, text="Удалить", command=self.delete_password).pack(side=tk.LEFT, padx=5)
        tk.Button(toolbar, text="Копировать пароль", command=self.copy_password).pack(side=tk.LEFT, padx=5)
        
        # Поиск
        search_frame = tk.Frame(toolbar)
        search_frame.pack(side=tk.RIGHT)
        
        tk.Label(search_frame, text="Поиск:").pack(side=tk.LEFT)
        self.search_var = tk.StringVar()
        self.search_entry = tk.Entry(search_frame, textvariable=self.search_var, width=20)
        self.search_entry.pack(side=tk.LEFT, padx=5)
        self.search_entry.bind("<KeyRelease>", self.search_passwords)
        
        # Таблица с паролями
        tree_frame = tk.Frame(self.root)
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        self.tree = ttk.Treeview(tree_frame, columns=("Сервис", "Логин", "Пароль"), show="headings")
        
        # Настройка колонок
        self.tree.heading("Сервис", text="Сервис")
        self.tree.heading("Логин", text="Логин")
        self.tree.heading("Пароль", text="Пароль")
        
        self.tree.column("Сервис", width=200)
        self.tree.column("Логин", width=200)
        self.tree.column("Пароль", width=200)
        
        # Полоса прокрутки
        scrollbar = ttk.Scrollbar(tree_frame, orient=tk.VERTICAL, command=self.tree.yview)
        self.tree.configure(yscrollcommand=scrollbar.set)
        
        self.tree.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # Двойной клик для редактирования
        self.tree.bind("<Double-1>", lambda e: self.edit_password())
    
    def load_data(self):
        """Загрузка данных из файла"""
        if os.path.exists(self.data_file):
            try:
                with open(self.data_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except:
                return []
        return []
    
    def save_data(self):
        """Сохранение данных в файл"""
        with open(self.data_file, 'w', encoding='utf-8') as f:
            json.dump(self.passwords, f, ensure_ascii=False, indent=2)
    
    def refresh_treeview(self):
        """Обновление таблицы"""
        for item in self.tree.get_children():
            self.tree.delete(item)
        
        for pw in self.passwords:
            self.tree.insert("", tk.END, values=(
                pw["service"],
                pw["login"],
                "•" * 10  # Скрываем пароль
            ))
    
    def encrypt(self, text):
        """Простое шифрование (base64)"""
        return base64.b64encode(text.encode()).decode()
    
    def decrypt(self, text):
        """Расшифровка"""
        return base64.b64decode(text.encode()).decode()
    
    def add_password(self):
        """Добавление нового пароля"""
        self.show_password_dialog()
    
    def edit_password(self):
        """Редактирование выбранного пароля"""
        selected = self.tree.selection()
        if not selected:
            messagebox.showwarning("Внимание", "Выберите запись для редактирования")
            return
        
        index = self.tree.index(selected[0])
        self.show_password_dialog(index)
    
    def delete_password(self):
        """Удаление пароля"""
        selected = self.tree.selection()
        if not selected:
            messagebox.showwarning("Внимание", "Выберите запись для удаления")
            return
        
        if messagebox.askyesno("Подтверждение", "Удалить выбранную запись?"):
            index = self.tree.index(selected[0])
            self.passwords.pop(index)
            self.save_data()
            self.refresh_treeview()
    
    def copy_password(self):
        """Копирование пароля в буфер обмена"""
        selected = self.tree.selection()
        if not selected:
            messagebox.showwarning("Внимание", "Выберите запись")
            return
        
        index = self.tree.index(selected[0])
        password = self.decrypt(self.passwords[index]["password"])
        
        self.root.clipboard_clear()
        self.root.clipboard_append(password)
        messagebox.showinfo("Успех", "Пароль скопирован в буфер обмена")
    
    def search_passwords(self, event=None):
        """Поиск паролей"""
        query = self.search_var.get().lower()
        
        for item in self.tree.get_children():
            self.tree.delete(item)
        
        for pw in self.passwords:
            if query in pw["service"].lower() or query in pw["login"].lower():
                self.tree.insert("", tk.END, values=(
                    pw["service"],
                    pw["login"],
                    "•" * 10
                ))
    
    def show_password_dialog(self, index=None):
        """Диалоговое окно для добавления/редактирования"""
        dialog = tk.Toplevel(self.root)
        dialog.title("Добавить пароль" if index is None else "Редактировать пароль")
        dialog.geometry("400x300")
        dialog.transient(self.root)
        dialog.grab_set()
        
        # Переменные для формы
        service_var = tk.StringVar()
        login_var = tk.StringVar()
        password_var = tk.StringVar()
        show_password = tk.BooleanVar()
        
        # Заполняем данные если редактирование
        if index is not None:
            service_var.set(self.passwords[index]["service"])
            login_var.set(self.passwords[index]["login"])
            password_var.set(self.decrypt(self.passwords[index]["password"]))
        
        # Поля формы
        tk.Label(dialog, text="Сервис:").pack(pady=5)
        service_entry = tk.Entry(dialog, textvariable=service_var, width=40)
        service_entry.pack(pady=5)
        
        tk.Label(dialog, text="Логин:").pack(pady=5)
        login_entry = tk.Entry(dialog, textvariable=login_var, width=40)
        login_entry.pack(pady=5)
        
        tk.Label(dialog, text="Пароль:").pack(pady=5)
        password_frame = tk.Frame(dialog)
        password_frame.pack(pady=5)
        
        password_entry = tk.Entry(password_frame, textvariable=password_var, width=30, show="•")
        password_entry.pack(side=tk.LEFT)
        
        def toggle_password():
            if show_password.get():
                password_entry.config(show="")
            else:
                password_entry.config(show="•")
        
        show_cb = tk.Checkbutton(password_frame, text="Показать", variable=show_password,
                                command=toggle_password)
        show_cb.pack(side=tk.LEFT, padx=5)
        
        def save_password():
            """Сохранение пароля"""
            service = service_var.get().strip()
            login = login_var.get().strip()
            password = password_var.get()
            
            if not service or not login or not password:
                messagebox.showerror("Ошибка", "Заполните все поля")
                return
            
            encrypted_password = self.encrypt(password)
            password_data = {
                "service": service,
                "login": login,
                "password": encrypted_password
            }
            
            if index is None:
                self.passwords.append(password_data)
            else:
                self.passwords[index] = password_data
            
            self.save_data()
            self.refresh_treeview()
            dialog.destroy()
        
        # Кнопки
        button_frame = tk.Frame(dialog)
        button_frame.pack(pady=20)
        
        tk.Button(button_frame, text="Сохранить", command=save_password).pack(side=tk.LEFT, padx=10)
        tk.Button(button_frame, text="Отмена", command=dialog.destroy).pack(side=tk.LEFT, padx=10)

root = tk.Tk()
app = PasswordManager(root)
root.mainloop()