import tkinter as tk
from tkinter import ttk, messagebox
import os
import shutil
from datetime import datetime

class FileManager:
    def __init__(self, root):
        self.root = root
        self.root.title("Файловый менеджер")
        self.root.geometry("800x600")
        
        self.current_path = os.getcwd()
        self.selected_item = None
        
        self.create_widgets()
        self.load_directory()
    
    def create_widgets(self):
        """Создание интерфейса"""
        # Верхняя панель
        top_frame = tk.Frame(self.root)
        top_frame.pack(fill=tk.X, padx=10, pady=5)
        
        # Кнопка "Наверх"
        tk.Button(top_frame, text="↑", command=self.go_up).pack(side=tk.LEFT, padx=5)
        
        # Поле текущего пути
        self.path_var = tk.StringVar()
        path_entry = tk.Entry(top_frame, textvariable=self.path_var, width=60)
        path_entry.pack(side=tk.LEFT, padx=5, fill=tk.X, expand=True)
        path_entry.bind("<Return>", self.navigate_to_path)
        
        # Кнопка обновления
        tk.Button(top_frame, text="Обновить", command=self.load_directory).pack(side=tk.LEFT, padx=5)
        
        # Область содержимого
        content_frame = tk.Frame(self.root)
        content_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=5)
        
        # Дерево папок слева
        left_frame = tk.Frame(content_frame, width=200)
        left_frame.pack(side=tk.LEFT, fill=tk.Y, padx=(0, 10))
        
        tk.Label(left_frame, text="Папки", font=("Arial", 10, "bold")).pack(anchor=tk.W)
        
        self.tree = ttk.Treeview(left_frame, show="tree")
        self.tree.pack(fill=tk.BOTH, expand=True, pady=5)
        self.tree.bind("<<TreeviewSelect>>", self.on_tree_select)
        
        # Список файлов справа
        right_frame = tk.Frame(content_frame)
        right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)
        
        # Заголовок списка файлов
        file_header = tk.Frame(right_frame)
        file_header.pack(fill=tk.X)
        
        tk.Label(file_header, text="Файлы", font=("Arial", 10, "bold")).pack(anchor=tk.W)
        
        # Список файлов с деталями
        self.file_tree = ttk.Treeview(right_frame, columns=("size", "modified", "type"), show="tree headings")
        self.file_tree.heading("#0", text="Имя")
        self.file_tree.heading("size", text="Размер")
        self.file_tree.heading("modified", text="Изменен")
        self.file_tree.heading("type", text="Тип")
        
        self.file_tree.column("#0", width=200)
        self.file_tree.column("size", width=80)
        self.file_tree.column("modified", width=120)
        self.file_tree.column("type", width=100)
        
        self.file_tree.pack(fill=tk.BOTH, expand=True)
        self.file_tree.bind("<<TreeviewSelect>>", self.on_file_select)
        self.file_tree.bind("<Double-1>", self.on_file_double_click)
        
        # Контекстное меню
        self.context_menu = tk.Menu(self.root, tearoff=0)
        self.context_menu.add_command(label="Открыть", command=self.open_selected)
        self.context_menu.add_command(label="Переименовать", command=self.rename_item)
        self.context_menu.add_command(label="Удалить", command=self.delete_item)
        self.context_menu.add_separator()
        self.context_menu.add_command(label="Свойства", command=self.show_properties)
        
        self.file_tree.bind("<Button-3>", self.show_context_menu)
        
        # Панель информации
        info_frame = tk.Frame(self.root)
        info_frame.pack(fill=tk.X, padx=10, pady=5)
        
        self.info_label = tk.Label(info_frame, text="", font=("Arial", 9))
        self.info_label.pack(anchor=tk.W)
        
        # Панель инструментов
        tool_frame = tk.Frame(self.root)
        tool_frame.pack(fill=tk.X, padx=10, pady=5)
        
        tk.Button(tool_frame, text="Новая папка", command=self.create_folder).pack(side=tk.LEFT, padx=5)
        tk.Button(tool_frame, text="Удалить", command=self.delete_item).pack(side=tk.LEFT, padx=5)
        tk.Button(tool_frame, text="Переименовать", command=self.rename_item).pack(side=tk.LEFT, padx=5)
        tk.Button(tool_frame, text="Свойства", command=self.show_properties).pack(side=tk.LEFT, padx=5)
    
    def load_directory(self, path=None):
        """Загрузка содержимого директории"""
        if path:
            self.current_path = path
        
        self.path_var.set(self.current_path)
        
        # Очищаем дерево папок
        for item in self.tree.get_children():
            self.tree.delete(item)
        
        # Очищаем список файлов
        for item in self.file_tree.get_children():
            self.file_tree.delete(item)
        
        # Загружаем дерево папок
        self.load_directory_tree()
        
        # Загружаем файлы текущей директории
        try:
            items = os.listdir(self.current_path)
            
            # Разделяем папки и файлы
            folders = []
            files = []
            
            for item in items:
                item_path = os.path.join(self.current_path, item)
                if os.path.isdir(item_path):
                    folders.append(item)
                else:
                    files.append(item)
            
            # Сортируем и добавляем папки
            for folder in sorted(folders):
                self.add_folder_to_list(folder)
            
            # Сортируем и добавляем файлы
            for file in sorted(files):
                self.add_file_to_list(file)
                
        except PermissionError:
            messagebox.showerror("Ошибка", "Нет доступа к директории")
    
    def load_directory_tree(self, parent="", path=None):
        """Загрузка дерева директорий"""
        if path is None:
            path = self.current_path
        
        try:
            items = os.listdir(path)
            for item in sorted(items):
                item_path = os.path.join(path, item)
                if os.path.isdir(item_path):
                    # Пропускаем скрытые папки
                    if not item.startswith('.'):
                        node = self.tree.insert(parent, "end", text=item, values=(item_path,))
                        # Рекурсивно добавляем подпапки (только первый уровень)
                        if parent == "":
                            self.load_directory_tree(node, item_path)
        except PermissionError:
            pass
    
    def add_folder_to_list(self, folder):
        """Добавление папки в список"""
        folder_path = os.path.join(self.current_path, folder)
        
        try:
            # Получаем информацию о папке
            stat = os.stat(folder_path)
            modified = datetime.fromtimestamp(stat.st_mtime).strftime("%Y-%m-%d %H:%M")
            item_count = len([name for name in os.listdir(folder_path) 
                            if not name.startswith('.')])
            
            self.file_tree.insert("", "end", text=folder, values=(
                f"{item_count} items", modified, "Папка"
            ), tags=("folder",))
            
        except PermissionError:
            self.file_tree.insert("", "end", text=folder, values=(
                "Нет доступа", "", "Папка"
            ), tags=("folder",))
    
    def add_file_to_list(self, file):
        """Добавление файла в список"""
        file_path = os.path.join(self.current_path, file)
        
        try:
            stat = os.stat(file_path)
            size = self.format_size(stat.st_size)
            modified = datetime.fromtimestamp(stat.st_mtime).strftime("%Y-%m-%d %H:%M")
            file_type = self.get_file_type(file)
            
            self.file_tree.insert("", "end", text=file, values=(
                size, modified, file_type
            ), tags=("file",))
            
        except PermissionError:
            self.file_tree.insert("", "end", text=file, values=(
                "Нет доступа", "", "Файл"
            ), tags=("file",))
    
    def format_size(self, size):
        """Форматирование размера файла"""
        for unit in ['B', 'KB', 'MB', 'GB']:
            if size < 1024.0:
                return f"{size:.1f} {unit}"
            size /= 1024.0
        return f"{size:.1f} TB"
    
    def get_file_type(self, filename):
        """Определение типа файла"""
        ext = os.path.splitext(filename)[1].lower()
        type_map = {
            '.txt': 'Текст',
            '.pdf': 'PDF',
            '.jpg': 'Изображение', '.jpeg': 'Изображение', '.png': 'Изображение',
            '.mp3': 'Аудио', '.wav': 'Аудио',
            '.mp4': 'Видео', '.avi': 'Видео',
            '.py': 'Python', '.java': 'Java', '.cpp': 'C++',
            '.doc': 'Word', '.docx': 'Word',
            '.xls': 'Excel', '.xlsx': 'Excel'
        }
        return type_map.get(ext, 'Файл')
    
    def on_tree_select(self, event):
        """Обработка выбора в дереве папок"""
        selection = self.tree.selection()
        if selection:
            path = self.tree.item(selection[0], "values")[0]
            self.load_directory(path)
    
    def on_file_select(self, event):
        """Обработка выбора файла"""
        selection = self.file_tree.selection()
        if selection:
            self.selected_item = self.file_tree.item(selection[0], "text")
            
            # Обновляем информацию
            item_path = os.path.join(self.current_path, self.selected_item)
            if os.path.exists(item_path):
                stat = os.stat(item_path)
                size = self.format_size(stat.st_size)
                modified = datetime.fromtimestamp(stat.st_mtime).strftime("%Y-%m-%d %H:%M:%S")
                created = datetime.fromtimestamp(stat.st_ctime).strftime("%Y-%m-%d %H:%M:%S")
                
                info = f"Имя: {self.selected_item} | Размер: {size} | Изменен: {modified}"
                self.info_label.config(text=info)
    
    def on_file_double_click(self, event):
        """Обработка двойного клика по файлу/папке"""
        selection = self.file_tree.selection()
        if selection:
            item = self.file_tree.item(selection[0], "text")
            item_path = os.path.join(self.current_path, item)
            
            if os.path.isdir(item_path):
                self.load_directory(item_path)
            else:
                self.open_file(item_path)
    
    def show_context_menu(self, event):
        """Показ контекстного меню"""
        item = self.file_tree.identify_row(event.y)
        if item:
            self.file_tree.selection_set(item)
            self.context_menu.post(event.x_root, event.y_root)
    
    def go_up(self):
        """Переход на уровень выше"""
        parent = os.path.dirname(self.current_path)
        if parent != self.current_path:  # Не корневая директория
            self.load_directory(parent)
    
    def navigate_to_path(self, event):
        """Навигация по введенному пути"""
        path = self.path_var.get()
        if os.path.exists(path) and os.path.isdir(path):
            self.load_directory(path)
        else:
            messagebox.showerror("Ошибка", "Указанный путь не существует или не является директорией")
    
    def create_folder(self):
        """Создание новой папки"""
        folder_name = tk.simpledialog.askstring("Новая папка", "Введите имя папки:")
        if folder_name:
            folder_path = os.path.join(self.current_path, folder_name)
            try:
                os.makedirs(folder_path, exist_ok=True)
                self.load_directory()
            except Exception as e:
                messagebox.showerror("Ошибка", f"Не удалось создать папку: {str(e)}")
    
    def delete_item(self):
        """Удаление выбранного элемента"""
        if not self.selected_item:
            messagebox.showwarning("Внимание", "Выберите файл или папку")
            return
        
        item_path = os.path.join(self.current_path, self.selected_item)
        
        if messagebox.askyesno("Подтверждение", f"Удалить '{self.selected_item}'?"):
            try:
                if os.path.isdir(item_path):
                    shutil.rmtree(item_path)
                else:
                    os.remove(item_path)
                self.load_directory()
            except Exception as e:
                messagebox.showerror("Ошибка", f"Не удалось удалить: {str(e)}")
    
    def rename_item(self):
        """Переименование выбранного элемента"""
        if not self.selected_item:
            messagebox.showwarning("Внимание", "Выберите файл или папку")
            return
        
        new_name = tk.simpledialog.askstring("Переименование", 
                                           "Введите новое имя:", 
                                           initialvalue=self.selected_item)
        if new_name and new_name != self.selected_item:
            old_path = os.path.join(self.current_path, self.selected_item)
            new_path = os.path.join(self.current_path, new_name)
            
            try:
                os.rename(old_path, new_path)
                self.load_directory()
            except Exception as e:
                messagebox.showerror("Ошибка", f"Не удалось переименовать: {str(e)}")
    
    def open_selected(self):
        """Открытие выбранного элемента"""
        if self.selected_item:
            item_path = os.path.join(self.current_path, self.selected_item)
            self.open_file(item_path)
    
    def open_file(self, file_path):
        """Открытие файла"""
        try:
            if os.name == 'nt':  # Windows
                os.startfile(file_path)
            else:  # Linux/Mac
                os.system(f'xdg-open "{file_path}"')
        except Exception as e:
            messagebox.showerror("Ошибка", f"Не удалось открыть файл: {str(e)}")
    
    def show_properties(self):
        """Показать свойства выбранного элемента"""
        if not self.selected_item:
            return
        
        item_path = os.path.join(self.current_path, self.selected_item)
        
        try:
            stat = os.stat(item_path)
            size = self.format_size(stat.st_size)
            modified = datetime.fromtimestamp(stat.st_mtime).strftime("%Y-%m-%d %H:%M:%S")
            created = datetime.fromtimestamp(stat.st_ctime).strftime("%Y-%m-%d %H:%M:%S")
            
            properties = f"Имя: {self.selected_item}\n"
            properties += f"Путь: {item_path}\n"
            properties += f"Размер: {size}\n"
            properties += f"Создан: {created}\n"
            properties += f"Изменен: {modified}\n"
            properties += f"Тип: {'Папка' if os.path.isdir(item_path) else 'Файл'}"
            
            messagebox.showinfo("Свойства", properties)
        except Exception as e:
            messagebox.showerror("Ошибка", f"Не удалось получить свойства: {str(e)}")

root = tk.Tk()
app = FileManager(root)
root.mainloop()