import tkinter as tk
from tkinter import messagebox
import math

class Calculator:
    def __init__(self, root):
        self.root = root
        self.root.title("Калькулятор с историей")
        self.root.geometry("500x600")
        
        self.current_input = ""
        self.result = ""
        self.memory = 0
        self.history = []
        
        self.create_widgets()
        self.update_display()
    
    def create_widgets(self):
        """Создание интерфейса калькулятора"""
        # Основной фрейм
        main_frame = tk.Frame(self.root)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # Дисплей
        self.display_var = tk.StringVar()
        display = tk.Entry(main_frame, textvariable=self.display_var, 
                          font=("Arial", 20), justify=tk.RIGHT, state='readonly')
        display.pack(fill=tk.X, pady=10)
        
        # Фрейм для кнопок и истории
        content_frame = tk.Frame(main_frame)
        content_frame.pack(fill=tk.BOTH, expand=True)
        
        # Левая часть - кнопки калькулятора
        buttons_frame = tk.Frame(content_frame)
        buttons_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        
        # Правая часть - история
        history_frame = tk.Frame(content_frame, width=150)
        history_frame.pack(side=tk.RIGHT, fill=tk.Y, padx=(10, 0))
        history_frame.pack_propagate(False)
        
        # Заголовок истории
        tk.Label(history_frame, text="История", font=("Arial", 12, "bold")).pack(pady=5)
        
        # Список истории
        history_scrollbar = tk.Scrollbar(history_frame)
        history_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        self.history_listbox = tk.Listbox(history_frame, font=("Arial", 9),
                                         yscrollcommand=history_scrollbar.set)
        self.history_listbox.pack(fill=tk.BOTH, expand=True)
        history_scrollbar.config(command=self.history_listbox.yview)
        
        # Кнопка очистки истории
        tk.Button(history_frame, text="Очистить историю", 
                 command=self.clear_history).pack(pady=5)
        
        # Создаем кнопки калькулятора
        buttons = [
            ['C', '⌫', '%', '/'],
            ['7', '8', '9', '*'],
            ['4', '5', '6', '-'],
            ['1', '2', '3', '+'],
            ['0', '.', '=', 'M']
        ]
        
        # Специальные кнопки памяти
        memory_buttons = ['MC', 'MR', 'M+', 'M-']
        
        # Создаем кнопки памяти
        memory_frame = tk.Frame(buttons_frame)
        memory_frame.pack(fill=tk.X)
        
        for mb in memory_buttons:
            btn = tk.Button(memory_frame, text=mb, font=("Arial", 10),
                          command=lambda x=mb: self.memory_operation(x))
            btn.pack(side=tk.LEFT, expand=True, fill=tk.X, padx=2, pady=2)
        
        # Создаем основную клавиатуру
        for row in buttons:
            row_frame = tk.Frame(buttons_frame)
            row_frame.pack(fill=tk.X)
            
            for text in row:
                if text == '=':
                    btn = tk.Button(row_frame, text=text, font=("Arial", 12),
                                  command=self.calculate, bg="orange")
                elif text in ['C', '⌫']:
                    btn = tk.Button(row_frame, text=text, font=("Arial", 12),
                                  command=lambda x=text: self.special_operation(x), bg="lightcoral")
                elif text in ['/', '*', '-', '+', '%']:
                    btn = tk.Button(row_frame, text=text, font=("Arial", 12),
                                  command=lambda x=text: self.append_operator(x), bg="lightgray")
                elif text == 'M':
                    btn = tk.Button(row_frame, text=text, font=("Arial", 10),
                                  command=self.show_memory, bg="lightblue")
                else:
                    btn = tk.Button(row_frame, text=text, font=("Arial", 12),
                                  command=lambda x=text: self.append_number(x))
                
                btn.pack(side=tk.LEFT, expand=True, fill=tk.X, padx=2, pady=2)
    
    def append_number(self, number):
        """Добавление числа"""
        self.current_input += str(number)
        self.update_display()
    
    def append_operator(self, operator):
        """Добавление оператора"""
        if self.current_input and self.current_input[-1] not in ['+', '-', '*', '/']:
            self.current_input += operator
            self.update_display()
    
    def special_operation(self, operation):
        """Специальные операции (C, ⌫)"""
        if operation == 'C':
            self.current_input = ""
            self.result = ""
        elif operation == '⌫':
            self.current_input = self.current_input[:-1]
        
        self.update_display()
    
    def memory_operation(self, operation):
        """Операции с памятью"""
        if operation == 'MC':
            self.memory = 0
        elif operation == 'MR':
            self.current_input += str(self.memory)
        elif operation == 'M+':
            try:
                self.memory += eval(self.current_input)
            except:
                pass
        elif operation == 'M-':
            try:
                self.memory -= eval(self.current_input)
            except:
                pass
        
        self.update_display()
    
    def show_memory(self):
        """Показать значение памяти"""
        messagebox.showinfo("Память", f"Текущее значение: {self.memory}")
    
    def calculate(self):
        """Вычисление результата"""
        try:
            # Безопасное вычисление
            allowed_chars = set('0123456789+-*/.() ')
            if all(c in allowed_chars for c in self.current_input):
                result = eval(self.current_input)
                self.result = str(result)
                
                # Добавляем в историю
                history_entry = f"{self.current_input} = {self.result}"
                self.history.append(history_entry)
                self.history_listbox.insert(tk.END, history_entry)
                
                self.current_input = self.result
                self.update_display()
            else:
                messagebox.showerror("Ошибка", "Недопустимое выражение")
                
        except ZeroDivisionError:
            messagebox.showerror("Ошибка", "Деление на ноль!")
            self.current_input = ""
            self.update_display()
        except Exception as e:
            messagebox.showerror("Ошибка", f"Ошибка вычисления: {str(e)}")
    
    def clear_history(self):
        """Очистка истории"""
        self.history.clear()
        self.history_listbox.delete(0, tk.END)
    
    def update_display(self):
        """Обновление дисплея"""
        display_text = self.current_input if self.current_input else "0"
        self.display_var.set(display_text)

root = tk.Tk()
calculator = Calculator(root)
root.mainloop()